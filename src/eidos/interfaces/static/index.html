<!DOCTYPE html>
<html>
<head>
    <title>Eidos Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #1e1e1e; color: #d4d4d4; }
        #sidebar { width: 300px; background: #252526; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; gap: 15px; }
        #cy { flex: 1; background: #1e1e1e; }
        h1 { margin-top: 0; font-size: 1.2em; color: #007acc; }
        .card { background: #333; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        button { padding: 10px; background: #0e639c; color: white; border: none; cursor: pointer; border-radius: 2px; }
        button:hover { background: #1177bb; }
        pre { white-space: pre-wrap; word-break: break-all; font-size: 0.8em; color: #ce9178; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h1>Eidos Studio</h1>
        <div>
            <button onclick="loadGraph()">â†» Reload Topology</button>
        </div>
        <div class="card">
            <strong>Pipeline Status</strong>
            <div id="status">Ready</div>
        </div>
        <div class="card" id="node-details" style="display:none">
            <strong>Selected Node</strong>
            <pre id="json-config"></pre>
        </div>
    </div>
    <div id="cy"></div>

    <script>
        let cy = null;

        async function loadGraph() {
            document.getElementById('status').innerText = "Loading...";
            try {
                const res = await fetch('/api/graph');
                const data = await res.json();
                
                if(data.error) {
                    document.getElementById('status').innerText = "Error: " + data.error;
                    return;
                }

                const elements = [];
                data.nodes.forEach(n => {
                    // Parse config string back to object if possible for display
                    let label = n.type;
                    elements.push({ 
                        data: { 
                            id: n.id, 
                            label: label,
                            type: n.type,
                            config: n.config 
                        } 
                    });
                });
                data.edges.forEach(e => {
                    elements.push({ data: { source: e[0], target: e[1] } });
                });

                if(cy) {
                    cy.destroy();
                }

                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'background-color': '#3a3a3a',
                                'border-width': 2,
                                'border-color': '#007acc',
                                'label': 'data(label)',
                                'color': '#fff',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'shape': 'round-rectangle',
                                'width': '120px',
                                'height': '60px',
                                'font-size': '12px'
                            }
                        },
                        {
                            selector: 'node[type="Source"]',
                            style: { 'background-color': '#2e5c55', 'border-color': '#4ec9b0' }
                        },
                        {
                            selector: 'node[type="Sink"]',
                            style: { 'background-color': '#5c2e2e', 'border-color': '#ce9178' }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': '#555',
                                'target-arrow-color': '#555',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier'
                            }
                        },
                        {
                            selector: ':selected',
                            style: {
                                'border-width': 4,
                                'border-color': '#fff'
                            }
                        }
                    ],
                    layout: {
                        name: 'breadthfirst',
                        directed: true,
                        padding: 50,
                        spacingFactor: 1.5
                    }
                });
                
                cy.on('tap', 'node', function(evt){
                    var node = evt.target;
                    document.getElementById('node-details').style.display = 'block';
                    document.getElementById('json-config').innerText = node.data('config');
                });

                document.getElementById('status').innerText = `Loaded ${data.nodes.length} nodes.`;
                
            } catch(e) {
                document.getElementById('status').innerText = "Connection Failed";
            }
        }

        // Load on start
        loadGraph();
    </script>
</body>
</html>
